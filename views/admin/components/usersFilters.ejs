<link rel="stylesheet" href="/styles/admin/components/usersFilters.css">
<div class="filterBox">
    <details id="filterMenu">
        <summary>
            <span class="material-symbols-outlined openFilters">
            filter_alt
            </span>
            <span class="material-symbols-outlined closeFilters">
                filter_alt_off
            </span>
        </summary>

        <div class="filters">
            <div class="filterField">
                <input type="text" name="filterNome" id="filterNome" placeholder="Nome">
                <input type="text" id="filterCognome" placeholder="Cognome">
            </div>
            <div class="filterField">
                <label for="filterPatente">Patente</label>
                <select id="filterPatente" name="filterPatente">
                    <option value="all">Tutte</option>
                    <option value="AM">AM</option>
                    <option value="A1">A1</option>
                    <option value="B">B</option>
                    <option value="C">C</option>
                    <option value="D">D</option>
                    <option value="estensioneA1B">estensione A1B</option>
                </select>
            </div>
            <div class="filterField">
                <div class="checkboxField">
                    <label for="archiviato">archiviati</label>
                    <input type="checkbox" id="archiviato">
                </div>
            </div>
            <div class="filterField">
                <h3>Registrazione</h3>
                <label for="filterRegistrazioneFrom">Da</label>
                <input type="date" id="filterRegistrazioneFrom" name="filterRegistrazioneFrom">
                <label for="filterRegistrazioneTo">A</label>
                <input type="date" id="filterRegistrazioneTo" name="filterRegistrazioneTo">
            </div>
            <div class="filterField">
                <h3>Visita Medica</h3>
                <label for="filterVisitaFrom">Da</label>
                <input type="date" id="filterVisitaFrom" name="filterVisitaFrom">
                <label for="filterVisitaTo">A</label>
                <input type="date" id="filterVisitaTo" name="filterVisitaTo">
                <div class="checkboxField">
                    <label for="filterVisitaMancante">visita Mancante</label>
                    <input type="checkbox" id="filterVisitaMancante" name="filterVisitaMancante">
                </div>
            </div>
            <div class="filterField">
                <h3>Esame Teoria</h3>
                <label for="filterEsameFrom">Da</label>
                <input type="date" id="filterEsameFrom" name="filterEsameFrom">
                <label for="filterEsameTo">A</label>
                <input type="date" id="filterEsameTo" name="filterEsameTo">
            </div>
        </div>
    </details>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const filterNome = document.getElementById('filterNome');
        const filterCognome = document.getElementById('filterCognome');
        const filterVisitaFrom = document.getElementById('filterVisitaFrom');
        const filterVisitaTo = document.getElementById('filterVisitaTo');
        const filterVisitaMancante = document.getElementById('filterVisitaMancante');
        const filterPatente = document.getElementById('filterPatente');
        const filterArchiviato = document.getElementById('archiviato');
        const filterRegistrazioneFrom = document.getElementById('filterRegistrazioneFrom');
        const filterRegistrazioneTo = document.getElementById('filterRegistrazioneTo');
        const filterEsameFrom = document.getElementById('filterEsameFrom');
        const filterEsameTo = document.getElementById('filterEsameTo');
        const tableBody = document.getElementById('usersTableBody');
        const rows = tableBody.getElementsByTagName('tr');

        function filterTable() {
            const nome = filterNome.value.toLowerCase();
            const cognome = filterCognome.value.toLowerCase();
            const patente = filterPatente.value.toLowerCase();
            const dataRegistrazioneDa = filterRegistrazioneFrom.value;
            const dataRegistrazioneA = filterRegistrazioneTo.value;
            const dataVisitaDa = filterVisitaFrom.value;
            const dataVisitaA = filterVisitaTo.value;
            const visitaMancante = filterVisitaMancante.checked;
            const dataEsameDa = filterEsameFrom.value;
            const dataEsameA = filterEsameTo.value;
            const archiviato = filterArchiviato.checked;
            let enumeration = 1;
            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                const numTd = row.getElementsByTagName('td')[0].textContent.toLowerCase();
                const nomeTd = row.getElementsByTagName('td')[1].textContent.toLowerCase();
                const cognomeTd = row.getElementsByTagName('td')[2].textContent.toLowerCase();
                const visitaTd = row.getElementsByTagName('td')[5].textContent.toLowerCase();
                const patenteTd = row.getElementsByTagName('td')[6].textContent.toLowerCase();
                const dataRegTd = row.getElementsByTagName('td')[7].textContent.toLowerCase();
                const dataEsamiTd = row.getElementsByTagName('td')[8].textContent.toLowerCase().replace(/\s+/g, ' ').trim().split(' ');
                const isArchiviato = Boolean(row.dataset.archiviato);
                let isDateEsameInRange;
                for (const esame of dataEsamiTd) {
                    const dataEsame = new Date(esame.split('/').reverse().join('-'));
                    const startEsameDate = new Date(dataEsameDa);
                    const endEsameDate = new Date(dataEsameA);
                    isDateEsameInRange = dataEsame >= startEsameDate && dataEsame <= endEsameDate;
                    if (isDateEsameInRange) break;
                }
                let isDateVisitaInRange, isVisitaMancante;
                if(!visitaMancante){
                    const dataVisita = new Date(visitaTd.split('/').reverse().join('-'));
                    const startVisitaDate = new Date(dataVisitaDa);
                    const endVisitaDate = new Date(dataVisitaA);
                    isDateVisitaInRange = dataVisita >= startVisitaDate && dataVisita <= endVisitaDate;
                }else{
                    isVisitaMancante = visitaTd == 'mancante' ? true : false;      
                }
                const dataRegistrazione = new Date(dataRegTd.split('/').reverse().join('-'));
                const startRegistrazioneDate = new Date(dataRegistrazioneDa);
                const endRegistrazioneDate = new Date(dataRegistrazioneA);

                const isDateRegInRange = dataRegistrazione >= startRegistrazioneDate && dataRegistrazione <= endRegistrazioneDate;
                
                if (
                    (nome === '' || nomeTd.includes(nome)) &&
                    (cognome === '' || cognomeTd.includes(cognome)) &&
                    (patente === '' || patenteTd.includes(patente) || patente == 'all') &&
                    (dataRegistrazioneDa === '' || dataRegistrazioneA === '' || isDateRegInRange) &&
                    (dataVisitaDa === '' || dataVisitaA === '' || isDateVisitaInRange) &&
                    (!visitaMancante || isVisitaMancante) &&
                    (dataEsameDa === '' || dataEsameA === '' || isDateEsameInRange) &&
                    ((archiviato && isArchiviato) || (!archiviato && !isArchiviato))
                ) {
                    row.getElementsByTagName('td')[0].querySelector('.numero').innerText = enumeration++;
                    row.style.display = 'table-row';
                } else {
                    row.style.display = 'none';
                }
            }
        }

        filterNome.addEventListener('input', filterTable);
        filterCognome.addEventListener('input', filterTable);
        filterPatente.addEventListener('input', filterTable);
        filterVisitaFrom.addEventListener('input', filterTable);
        filterVisitaTo.addEventListener('input', filterTable);
        filterRegistrazioneFrom.addEventListener('input', filterTable);
        filterRegistrazioneTo.addEventListener('input', filterTable);
        filterVisitaMancante.addEventListener('input', filterTable);
        filterEsameFrom.addEventListener('input', filterTable);
        filterEsameTo.addEventListener('input', filterTable);
        filterArchiviato.addEventListener('input', filterTable);
    });
</script>