<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Allievi</title>
    <link rel="stylesheet" href="/styles/admin/users.css">
    <link rel="stylesheet" href="/styles/admin/rinnovi/users.css">
</head>
<body>
    <%- include('../components/header.ejs') %>
    
    <div id="searchUsersBtn">
        <span class="material-symbols-outlined">
            data_loss_prevention
        </span>
    </div>
    
    <div id="blurredBg"></div>
    <section id="searchDataContainer">
            <form id="searchDataForm" action="/rinnovi/findUsers" method="POST">
                <div class="field">
                    <span id="closeSearchFormBtn" class="material-symbols-outlined">
                        close
                    </span>
                </div>
                <div class="field">
                    <h3>Cerca Dati</h3>
                </div>
                <div class="field">
                    <label for="nPatente">Numero Patente</label>
                    <input type="text" name="nPatente" id="nPatente" placeholder=" ">
                </div>
                <div class="field">
                    <label for="cFiscale">Codice Fiscale</label>
                    <input type="text" name="cFiscale" id="cFiscale" placeholder=" ">
                </div>
                <div class="field">
                    <label for="protocollo">Protocollo</label>
                    <input type="text" name="protocollo" id="protocollo" placeholder=" ">
                </div>
                <div class="field">
                    <button type="submit">
                        <span class="material-symbols-outlined">
                            search
                        </span>
                    </button>
                </div>
            </form>
    </section>
    <script>
        const searchUsersBtn = document.getElementById('searchUsersBtn');
        const blurredBg = document.getElementById('blurredBg');
        const searchDataContainer = document.getElementById('searchDataContainer');
        const closeSearchFormBtn = document.getElementById('closeSearchFormBtn');
        searchUsersBtn.addEventListener('click', () => {
            blurredBg.style.display = 'block';
            searchDataContainer.style.display = 'flex';
            setTimeout(() => {
                blurredBg.style.opacity = .4;
                searchDataContainer.style.opacity = 1;
            }, 100);
        });
        closeSearchFormBtn.addEventListener('click', () => {
            blurredBg.style.opacity = 0;
            searchDataContainer.style.opacity = 0;
            setTimeout(() => {
                blurredBg.style.display = 'none';
                searchDataContainer.style.display = 'none';
            }, 500);
        });
    </script>
    <table>
        <form action="/rinnovi/deleteUsers" id="deleteUsersForm" method="POST">
            <thead>
                <tr>
                    <th>
                        <span id="selectUsers" class="material-symbols-outlined">
                            checklist
                        </span>
                        <button type="submit" class="elimina">
                            <span class="material-symbols-outlined">
                                delete_forever
                            </span>
                        </button>
                    </th>
                    <th>Nome</th>
                    <th>Cognome</th>
                    <th>Email</th>
                    <th>Telefono</th>
                    <th>Visita Medica</th>
                    <!-- <th>Fatture</th> -->
                </tr>
            </thead>
            <tbody id="usersTableBody">
                <% let enumArchiviati = 1 %>
                <% let enumUtenti = 1 %>
                <% users.forEach(function(user, index) { %>
                        <tr id="row<%= index %>" class="<%= user.archiviato ? 'archiviato' : '' %>" data-archiviato="<%= user.archiviato %>">
                            <td>
                                <div class="cellContent">
                                    <input class="elimina" type="checkbox" name="id<%= index %>" value="<%= user._id %>">
                                    <div class="numero">
                                        <%= user.archiviato ? enumArchiviati++ : enumUtenti++ %>
                                    </div>
                                </div>
                            </td>
                            <td><!-- <a href="<%#`/userPage?cf=${encodeURIComponent(user.cFiscale)}`%>"> --><%= user.nome %><!-- </a> --></td>
                            <td><%= user.cognome %></td>
                            <td><%= user.contatti.email %></td>
                            <td><%= user.contatti.tel %></td>
                            <td><%= user.visita ? `${user.visita.data.split('-').reverse().join('/')} ${user.visita.ora}`  : 'Mancante' %></td>
                        </tr>
                <% }); %>
            </tbody>
        </form>
    </table>
    <script>
        const selectUsersBtn = document.getElementById('selectUsers');
        const usersTd = document.querySelectorAll('.elimina');
        const deleteUsersForm = document.getElementById('deleteUsersForm');
        selectUsersBtn.addEventListener('click', () => {
            usersTd.forEach((td) => {
                td.style.display = td.style.display != 'inline-flex' ? 'inline-flex' : 'none';
            });
        });
        deleteUsersForm.addEventListener('submit',event => {
            const confirmSubmission = confirm("Sei sicuro di voler eliminare gli utenti selezionati?");
            if (!confirmSubmission) {
                event.preventDefault();
            }
        });
    </script>
</body>
</html>